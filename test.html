<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 인사이트 폴 프로토타입</title>
    <!-- jQuery CDN 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 기본 스타일 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* 컨테이너 */
        #poll-container {
            width: 100%;
            max-width: 500px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* 헤더 (질문) */
        #poll-header {
            padding: 24px;
            border-bottom: 1px solid #eee;
        }
        #poll-question {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            line-height: 1.4;
        }

        /* 투표 영역 */
        #poll-body {
            padding: 24px;
        }
        
        .poll-option {
            display: block;
            background-color: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .poll-option:hover {
            background-color: #f0f0f0;
        }

        /* 라디오 버튼 선택 시 스타일 */
        input[type="radio"] {
            display: none; /* 라디오 버튼 숨기기 */
        }
        input[type="radio"]:checked + .poll-option {
            border-color: #007bff;
            background-color: #e6f2ff;
        }
        
        .poll-option label {
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: block; /* 라벨 영역 전체가 클릭되도록 */
        }

        /* [고도화] 이유 입력창 */
        #reason-section {
            display: none; /* 기본 숨김 */
            padding: 0 24px 24px;
            animation: fadeIn 0.5s ease;
        }

        #reason-section label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }

        #poll-reason {
            width: 100%;
            padding: 12px;
            font-size: 0.95rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box; /* 패딩 포함 크기 계산 */
            min-height: 80px;
            resize: vertical;
        }
        
        /* 제출 버튼 */
        #submit-button {
            display: none; /* 기본 숨김 */
            width: calc(100% - 48px);
            margin: 0 24px 24px;
            padding: 16px;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            animation: fadeIn 0.5s ease;
        }
        
        #submit-button:hover {
            background-color: #0056b3;
        }

        /* [결과] AI 분석 결과 화면 */
        #results-container {
            display: none; /* 기본 숨김 */
            padding: 24px;
            animation: fadeIn 0.5s ease;
        }

        .result-group {
            margin-bottom: 20px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
        }
        
        .result-percentage-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: #007bff; /* 찬성 */
        }
        
        .result-group.disagree .result-percentage-total {
            color: #dc3545; /* 반대 */
        }

        /* AI 분석 논거 (가로 바) */
        .reason-bar {
            margin-bottom: 10px;
        }
        
        .reason-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 4px;
        }
        
        .reason-percentage {
            font-weight: 600;
        }

        .bar-background {
            background-color: #e9ecef;
            border-radius: 4px;
            height: 10px;
            overflow: hidden;
        }
        
        .bar-foreground {
            height: 100%;
            background-color: #007bff; /* 찬성 */
            border-radius: 4px;
        }
        
        .result-group.disagree .bar-foreground {
            background-color: #dc3545; /* 반대 */
        }

        /* 페이드인 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 슬라이드 애니메이션 */
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(100%); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        @keyframes slideOut {
            from { 
                opacity: 1; 
                transform: translateX(0); 
            }
            to { 
                opacity: 0; 
                transform: translateX(100%); 
            }
        }

        /* 처음으로 돌아가기 버튼 호버 효과 */
        #restart-button:hover {
            background-color: #007bff;
            color: #fff;
        }

        /* 로딩 상태 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        /* 에러 메시지 */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 24px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        /* 개인화된 인사이트 섹션 */
        .personal-insight {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }

        .personal-insight h3 {
            margin: 0 0 12px 0;
            color: #007bff;
            font-size: 1.1rem;
        }

        .personal-insight p {
            margin: 0;
            line-height: 1.6;
            color: #333;
        }

        /* 관련 고려사항 */
        .considerations {
            margin-top: 20px;
        }

        .considerations h4 {
            margin: 0 0 12px 0;
            color: #555;
            font-size: 1rem;
        }

        .considerations ul {
            margin: 0;
            padding-left: 20px;
        }

        .considerations li {
            margin-bottom: 8px;
            color: #666;
            line-height: 1.5;
        }

    </style>
</head>
<body>

    <div id="poll-container">
        
        <div id="poll-section">
            <div id="poll-header">
                <h2 id="poll-question">최근 논의되는 '주 4일제' 도입에 대해 어떻게 생각하시나요?</h2>
            </div>
            
            <div id="poll-body">
                <input type="radio" id="option-agree" name="poll-choice" value="agree">
                <label for="option-agree" class="poll-option">
                    <label for="option-agree">👍 찬성합니다</label>
                </label>
                
                <input type="radio" id="option-disagree" name="poll-choice" value="disagree">
                <label for="option-disagree" class="poll-option">
                    <label for="option-disagree">👎 반대합니다</label>
                </label>
                
                <input type="radio" id="option-neutral" name="poll-choice" value="neutral">
                <label for="option-neutral" class="poll-option">
                    <label for="option-neutral">🤔 잘 모르겠습니다 (중립)</label>
                </label>
            </div>

            <div id="reason-section">
                <label for="poll-reason">선택하신 이유를 간단히 알려주세요. (선택 사항)</label>
                <textarea id="poll-reason" placeholder="예: 워라밸 향상이 기대됩니다."></textarea>
            </div>
            
            <button id="submit-button">결과 보기 (제출)</button>
        </div>

        <div id="results-container">
            <div id="poll-header">
                <h2 id="poll-question">'주 4일제' 도입 AI 인사이트 결과</h2>
            </div>

            <div class="result-group agree">
                <div class="result-header">
                    <span class="result-title">👍 찬성</span>
                    <span class="result-percentage-total">62%</span>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>워라밸 및 삶의 질 향상</span>
                        <span class="reason-percentage">41%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 41%;"></div>
                    </div>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>업무 효율 및 생산성 증대</span>
                        <span class="reason-percentage">15%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 15%;"></div>
                    </div>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>기타 (내수 활성화 등)</span>
                        <span class="reason-percentage">6%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 6%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="result-group disagree">
                <div class="result-header">
                    <span class="result-title">👎 반대</span>
                    <span class="result-percentage-total">31%</span>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>중소기업 인건비/운영 부담</span>
                        <span class="reason-percentage">18%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 18%;"></div>
                    </div>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>실질적 생산성 하락 우려</span>
                        <span class="reason-percentage">9%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 9%;"></div>
                    </div>
                </div>
                <div class="reason-bar">
                    <div class="reason-label">
                        <span>기타 (고객 서비스 공백 등)</span>
                        <span class="reason-percentage">4%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 4%;"></div>
                    </div>
                </div>
            </div>

            <div class="result-group neutral">
                <div class="result-header">
                    <span class="result-title">🤔 중립 / 잘 모름</span>
                    <span class="result-percentage-total" style="color: #6c757d;">7%</span>
                </div>
            </div>

            <!-- 처음으로 돌아가기 버튼 -->
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <button id="restart-button" style="
                    padding: 12px 24px;
                    font-size: 1rem;
                    font-weight: 600;
                    color: #007bff;
                    background-color: #fff;
                    border: 2px solid #007bff;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                ">처음으로 돌아가기</button>
            </div>
        </div>

    </div>

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">AI가 분석 중입니다...</div>
        </div>
    </div>

    <!-- 에러 메시지 -->
    <div id="error-message" class="error-message"></div>

    <script>
        // DOM 요소 가져오기
        const pollSection = document.getElementById('poll-section');
        const reasonSection = document.getElementById('reason-section');
        const submitButton = document.getElementById('submit-button');
        const resultsContainer = document.getElementById('results-container');
        const pollChoices = document.querySelectorAll('input[name="poll-choice"]');
        const restartButton = document.getElementById('restart-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorMessage = document.getElementById('error-message');

        // 로컬 스토리지 키
        const STORAGE_KEYS = {
            POLL_DATA: 'ai_poll_data',
            USER_SESSION: 'ai_poll_session',
            ANALYTICS: 'ai_poll_analytics'
        };

        // 세션 ID 생성
        const sessionId = generateSessionId();
        
        // 페이지 로드 시 이전 데이터 복원
        document.addEventListener('DOMContentLoaded', function() {
            restorePreviousData();
            trackPageView();
            updateMockModeIndicator(); // Mock 모드 상태 표시 초기화
        });

        // 라디오 버튼 선택 시 이벤트 리스너
        pollChoices.forEach(choice => {
            choice.addEventListener('change', function() {
                // 선택 데이터 저장
                savePollData({
                    choice: this.value,
                    timestamp: new Date().toISOString()
                });
                
                // 사용자 행동 추적
                trackUserAction('choice_selected', {
                    choice: this.value,
                    sessionId: sessionId
                });
                
                // '중립'이 아닐 때만 이유 섹션과 제출 버튼 표시
                if (this.value !== 'neutral') {
                    reasonSection.style.display = 'block';
                } else {
                    reasonSection.style.display = 'none'; // 중립이면 이유 숨김
                }
                submitButton.style.display = 'block'; // 어떤 선택이든 제출 버튼은 표시
            });
        });

        // 제출 버튼 클릭 시 (실제 AI API 호출)
        submitButton.addEventListener('click', function() {
            const selectedChoice = document.querySelector('input[name="poll-choice"]:checked');
            const reason = document.getElementById('poll-reason').value;
            
            if (!selectedChoice) {
                showErrorMessage('선택지를 선택해주세요.');
                return;
            }
            
            // 입력 데이터 검증
            if (!validateInput(selectedChoice.value, reason)) {
                return;
            }
            
            // 제출 데이터 저장
            const submissionData = {
                choice: selectedChoice.value,
                reason: reason,
                timestamp: new Date().toISOString(),
                sessionId: sessionId
            };
            
            savePollData(submissionData);
            
            // 사용자 행동 추적
            trackUserAction('poll_submitted', {
                choice: selectedChoice.value,
                hasReason: reason.trim().length > 0,
                sessionId: sessionId
            });
            
            // 로딩 상태 표시
            showLoadingState();
            
            // Mock 모드에서는 캐시를 완전히 무시하고 매번 새로운 요청
            const cacheKey = `poll_result_${selectedChoice.value}_${reason.trim()}_${Date.now()}`;
            
            // Mock 모드가 아닌 경우에만 캐시 확인
            if (!isMockMode()) {
                const cachedResult = getCachedResult(cacheKey);
                if (cachedResult) {
                    // 캐시된 결과 사용
                    setTimeout(() => {
                        displayAnalysisResult(cachedResult);
                        hideLoadingState();
                    }, 1000); // 1초 로딩 시뮬레이션
                    return;
                }
            }
            
            // jQuery AJAX로 API 호출
            $.ajax({
                url: 'https://apidev-www.hankyung.com/test/ai-poll/analyze',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'fbc6a0f8-6cea-447d-9bee-039d9c864aff'
                },
                data: JSON.stringify({
                    choice: selectedChoice.value,
                    reason: reason,
                    topic: '주 4일제',
                    sessionId: sessionId,
                    timestamp: Date.now(),  // 매번 다른 타임스탬프 추가
                    randomId: Math.random().toString(36).substr(2, 9),  // 랜덤 ID 추가
                    force_mock: isMockMode()  // Mock 모드 상태 전달
                }),
                dataType: 'json',
                timeout: 30000, // 30초 타임아웃
                success: function(result) {
                    if (result.code === 200) {
                        // Mock 모드가 아닌 경우에만 캐시에 저장
                        if (!result.mock_mode) {
                            setCachedResult(cacheKey, result.data);
                        }
                        
                        // Mock 모드 감지 및 사용자 알림
                        if (result.mock_mode) {
                            showMockModeNotification();
                        } else {
                            // 실제 AI 모드일 때도 알림 (선택사항)
                            console.log("실제 AI 분석이 완료되었습니다.");
                        }
                        
                        // AI 분석 결과를 동적으로 표시
                        displayAnalysisResult(result.data);
                        
                        // 성공 추적
                        trackUserAction('api_success', {
                            sessionId: sessionId,
                            responseTime: Date.now(),
                            mockMode: result.mock_mode || false
                        });
                    } else {
                        throw new Error(result.message || 'AI 분석 중 오류가 발생했습니다.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AI 분석 오류:', error);
                    console.error('상태:', status);
                    console.error('응답:', xhr.responseText);
                    
                    // 에러 추적
                    trackUserAction('api_error', {
                        error: error,
                        status: status,
                        sessionId: sessionId
                    });
                    
                    // 상세한 에러 메시지 표시
                    let errorMsg = 'AI 분석 중 오류가 발생했습니다.';
                    if (status === 'timeout') {
                        errorMsg = '요청 시간이 초과되었습니다. 잠시 후 다시 시도해주세요.';
                    } else if (xhr.status === 0) {
                        errorMsg = '네트워크 연결을 확인해주세요.';
                    } else if (xhr.status >= 500) {
                        errorMsg = '서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                    }
                    
                    showErrorMessage(errorMsg);
                },
                complete: function() {
                    // 성공/실패 관계없이 로딩 상태 숨김
                    hideLoadingState();
                }
            });
        });

        // 처음으로 돌아가기 버튼 클릭 시
        restartButton.addEventListener('click', function() {
            // 사용자 행동 추적
            trackUserAction('restart_poll', {
                sessionId: sessionId
            });
            
            // 1. 모든 선택 초기화
            pollChoices.forEach(choice => {
                choice.checked = false;
            });
            
            // 2. 이유 입력창 초기화 및 숨김
            document.getElementById('poll-reason').value = '';
            reasonSection.style.display = 'none';
            
            // 3. 제출 버튼 숨김
            submitButton.style.display = 'none';
            
            // 4. 투표 섹션 표시, 결과 섹션 숨김
            pollSection.style.display = 'block';
            resultsContainer.style.display = 'none';
            
            // 5. 에러 메시지 숨김
            errorMessage.style.display = 'none';
        });

        // 로딩 상태 표시
        function showLoadingState() {
            loadingOverlay.style.display = 'flex';
            errorMessage.style.display = 'none';
        }

        // 로딩 상태 숨김
        function hideLoadingState() {
            loadingOverlay.style.display = 'none';
        }

        // 에러 메시지 표시
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        // AI 분석 결과를 동적으로 표시
        function displayAnalysisResult(data) {
            // 투표 섹션 숨기고 결과 섹션 표시
            pollSection.style.display = 'none';
            resultsContainer.style.display = 'block';

            // 결과 데이터 업데이트
            updateResultsData(data);
        }

        // 결과 데이터 업데이트
        function updateResultsData(data) {
            // 전체 요약 업데이트
            const summaryElement = document.querySelector('#poll-question');
            if (summaryElement) {
                summaryElement.textContent = `'주 4일제' 도입 AI 인사이트 결과`;
            }

            // 찬성 퍼센트 업데이트
            const agreePercentage = document.querySelector('.result-group.agree .result-percentage-total');
            if (agreePercentage) {
                agreePercentage.textContent = `${data.agree_percentage}%`;
            }

            // 반대 퍼센트 업데이트
            const disagreePercentage = document.querySelector('.result-group.disagree .result-percentage-total');
            if (disagreePercentage) {
                disagreePercentage.textContent = `${data.disagree_percentage}%`;
            }

            // 중립 퍼센트 업데이트
            const neutralPercentage = document.querySelector('.result-group.neutral .result-percentage-total');
            if (neutralPercentage) {
                neutralPercentage.textContent = `${data.neutral_percentage}%`;
            }

            // 찬성 이유들 업데이트
            updateReasonBars('.result-group.agree', data.reasons.agree);

            // 반대 이유들 업데이트
            updateReasonBars('.result-group.disagree', data.reasons.disagree);

            // 개인화된 인사이트 추가
            addPersonalInsight(data.personal_insight);

            // 관련 고려사항 추가
            addConsiderations(data.related_considerations);
        }

        // 이유 바 업데이트 (랜덤 애니메이션)
        function updateReasonBars(containerSelector, reasons) {
            const container = document.querySelector(containerSelector);
            if (!container) return;

            // 기존 이유 바들 제거
            const existingBars = container.querySelectorAll('.reason-bar');
            existingBars.forEach(bar => bar.remove());

            // 새로운 이유 바들 추가 (랜덤 지연으로 애니메이션)
            reasons.forEach((reason, index) => {
                const reasonBar = document.createElement('div');
                reasonBar.className = 'reason-bar';
                reasonBar.style.opacity = '0';
                reasonBar.style.transform = 'translateY(20px)';
                
                reasonBar.innerHTML = `
                    <div class="reason-label">
                        <span>${reason.reason}</span>
                        <span class="reason-percentage">${reason.percentage}%</span>
                    </div>
                    <div class="bar-background">
                        <div class="bar-foreground" style="width: 0%;"></div>
                    </div>
                `;
                
                // 결과 헤더 다음에 추가
                const resultHeader = container.querySelector('.result-header');
                if (resultHeader) {
                    resultHeader.insertAdjacentElement('afterend', reasonBar);
                }

                // 랜덤 지연으로 애니메이션 (각 바마다 다른 시간)
                const delay = Math.random() * 300 + (index * 200);
                setTimeout(() => {
                    reasonBar.style.transition = 'all 0.5s ease';
                    reasonBar.style.opacity = '1';
                    reasonBar.style.transform = 'translateY(0)';
                    
                    // 바 애니메이션
                    const barForeground = reasonBar.querySelector('.bar-foreground');
                    setTimeout(() => {
                        barForeground.style.transition = 'width 1s ease';
                        barForeground.style.width = `${reason.percentage}%`;
                    }, 200);
                }, delay);
            });
        }

        // 개인화된 인사이트 추가
        function addPersonalInsight(insight) {
            // 기존 개인화된 인사이트 제거
            const existingInsight = document.querySelector('.personal-insight');
            if (existingInsight) {
                existingInsight.remove();
            }

            // 새로운 개인화된 인사이트 추가
            const insightElement = document.createElement('div');
            insightElement.className = 'personal-insight';
            insightElement.innerHTML = `
                <h3>🤖 AI 개인화 인사이트</h3>
                <p>${insight}</p>
            `;

            // 결과 컨테이너에 추가
            const neutralGroup = document.querySelector('.result-group.neutral');
            if (neutralGroup) {
                neutralGroup.insertAdjacentElement('afterend', insightElement);
            }
        }

        // 관련 고려사항 추가
        function addConsiderations(considerations) {
            // 기존 고려사항 제거
            const existingConsiderations = document.querySelector('.considerations');
            if (existingConsiderations) {
                existingConsiderations.remove();
            }

            // 새로운 고려사항 추가
            const considerationsElement = document.createElement('div');
            considerationsElement.className = 'considerations';
            
            const considerationsList = considerations.map(item => `<li>${item}</li>`).join('');
            considerationsElement.innerHTML = `
                <h4>💡 관련 고려사항</h4>
                <ul>${considerationsList}</ul>
            `;

            // 결과 컨테이너에 추가
            const restartButton = document.querySelector('#restart-button');
            if (restartButton) {
                restartButton.parentElement.insertAdjacentElement('beforebegin', considerationsElement);
            }
        }

        // ===== 새로운 유틸리티 함수들 =====

        // 세션 ID 생성
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 입력 데이터 검증
        function validateInput(choice, reason) {
            // 선택지 검증
            if (!choice || !['agree', 'disagree', 'neutral'].includes(choice)) {
                showErrorMessage('올바른 선택지를 선택해주세요.');
                return false;
            }

            // 이유 입력 검증 (중립이 아닌 경우)
            if (choice !== 'neutral' && reason.trim().length > 0) {
                if (reason.trim().length < 5) {
                    showErrorMessage('이유를 5자 이상 입력해주세요.');
                    return false;
                }
                if (reason.trim().length > 500) {
                    showErrorMessage('이유는 500자 이하로 입력해주세요.');
                    return false;
                }
            }

            return true;
        }

        // 로컬 스토리지에 투표 데이터 저장
        function savePollData(data) {
            try {
                const existingData = JSON.parse(localStorage.getItem(STORAGE_KEYS.POLL_DATA) || '[]');
                existingData.push(data);
                
                // 최대 10개까지만 저장
                if (existingData.length > 10) {
                    existingData.shift();
                }
                
                localStorage.setItem(STORAGE_KEYS.POLL_DATA, JSON.stringify(existingData));
            } catch (error) {
                console.error('데이터 저장 오류:', error);
            }
        }

        // 이전 데이터 복원
        function restorePreviousData() {
            try {
                const savedData = JSON.parse(localStorage.getItem(STORAGE_KEYS.POLL_DATA) || '[]');
                if (savedData.length > 0) {
                    const lastData = savedData[savedData.length - 1];
                    
                    // 마지막 선택 복원
                    const choiceElement = document.querySelector(`input[value="${lastData.choice}"]`);
                    if (choiceElement) {
                        choiceElement.checked = true;
                        
                        // 이유 섹션 표시
                        if (lastData.choice !== 'neutral') {
                            reasonSection.style.display = 'block';
                        }
                        
                        // 제출 버튼 표시
                        submitButton.style.display = 'block';
                        
                        // 이유 복원
                        if (lastData.reason) {
                            document.getElementById('poll-reason').value = lastData.reason;
                        }
                    }
                }
            } catch (error) {
                console.error('데이터 복원 오류:', error);
            }
        }

        // 캐시된 결과 가져오기
        function getCachedResult(key) {
            try {
                const cached = localStorage.getItem(`cache_${key}`);
                if (cached) {
                    const data = JSON.parse(cached);
                    // 1시간 이내 캐시만 유효
                    if (Date.now() - data.timestamp < 3600000) {
                        return data.result;
                    }
                }
            } catch (error) {
                console.error('캐시 읽기 오류:', error);
            }
            return null;
        }

        // 결과 캐시에 저장
        function setCachedResult(key, result) {
            try {
                const cacheData = {
                    result: result,
                    timestamp: Date.now()
                };
                localStorage.setItem(`cache_${key}`, JSON.stringify(cacheData));
            } catch (error) {
                console.error('캐시 저장 오류:', error);
            }
        }

        // 사용자 행동 추적
        function trackUserAction(action, data = {}) {
            try {
                const analytics = JSON.parse(localStorage.getItem(STORAGE_KEYS.ANALYTICS) || '[]');
                analytics.push({
                    action: action,
                    data: data,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
                
                // 최대 100개 이벤트만 저장
                if (analytics.length > 100) {
                    analytics.shift();
                }
                
                localStorage.setItem(STORAGE_KEYS.ANALYTICS, JSON.stringify(analytics));
                
                // 실제 분석 서비스로 전송 (예: Google Analytics)
                if (typeof gtag !== 'undefined') {
                    gtag('event', action, {
                        'custom_parameter': JSON.stringify(data)
                    });
                }
            } catch (error) {
                console.error('분석 추적 오류:', error);
            }
        }

        // 페이지 뷰 추적
        function trackPageView() {
            trackUserAction('page_view', {
                sessionId: sessionId,
                referrer: document.referrer,
                timestamp: new Date().toISOString()
            });
        }

        // 에러 메시지 표시 (개선된 버전)
        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            
            // 5초 후 자동 숨김
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
            
            // 에러 추적
            trackUserAction('error_message_shown', {
                message: message,
                sessionId: sessionId
            });
        }

        // 키보드 접근성 개선
        document.addEventListener('keydown', function(e) {
            // ESC 키로 에러 메시지 닫기
            if (e.key === 'Escape' && errorMessage.style.display === 'block') {
                errorMessage.style.display = 'none';
            }
            
            // Enter 키로 제출 (선택된 상태에서)
            if (e.key === 'Enter' && submitButton.style.display === 'block') {
                const selectedChoice = document.querySelector('input[name="poll-choice"]:checked');
                if (selectedChoice) {
                    submitButton.click();
                }
            }
        });

        // 페이지 언로드 시 데이터 정리
        window.addEventListener('beforeunload', function() {
            trackUserAction('page_unload', {
                sessionId: sessionId,
                timestamp: new Date().toISOString()
            });
        });

        // Mock 모드 감지 함수
        function isMockMode() {
            // URL이나 환경에 따라 Mock 모드 감지
            return window.location.hostname.includes('localhost') || 
                   window.location.hostname.includes('127.0.0.1') ||
                   window.location.hostname.includes('dev') ||
                   localStorage.getItem('mock_mode') === 'true';
        }

        // Mock 모드 토글 함수
        function toggleMockMode() {
            const currentMode = localStorage.getItem('mock_mode') === 'true';
            localStorage.setItem('mock_mode', (!currentMode).toString());
            
            const status = !currentMode ? '활성화' : '비활성화';
            alert(`Mock 모드가 ${status}되었습니다. 페이지를 새로고침해주세요.`);
            
            // 상태 표시 업데이트
            updateMockModeIndicator();
        }

        // Mock 모드 상태 표시 업데이트
        function updateMockModeIndicator() {
            const isMock = isMockMode();
            const indicator = document.getElementById('mock-mode-indicator');
            
            if (indicator) {
                indicator.textContent = isMock ? 'Mock 모드 ON' : 'Mock 모드 OFF';
                indicator.style.backgroundColor = isMock ? '#28a745' : '#6c757d';
            }
        }

        // Mock 모드 알림 표시 (랜덤 메시지)
        function showMockModeNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #fff3cd;
                color: #856404;
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #ffeaa7;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 10000;
                font-size: 0.9rem;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            // 랜덤한 알림 메시지들
            const messages = [
                {
                    title: "🤖 시뮬레이션 모드",
                    content: "현재 AI 분석이 시뮬레이션으로 실행되고 있습니다. 실제 AI 서비스 설정이 필요합니다."
                },
                {
                    title: "⚡ 빠른 분석 모드",
                    content: "빠른 응답을 위해 시뮬레이션 분석을 제공하고 있습니다. 더 정확한 분석을 원하시면 AI 서비스를 설정해주세요."
                },
                {
                    title: "🎯 데모 모드",
                    content: "데모용 시뮬레이션 분석이 실행되었습니다. 실제 서비스에서는 AI 분석을 제공합니다."
                },
                {
                    title: "🔧 개발 모드",
                    content: "개발 환경에서 시뮬레이션 분석을 제공하고 있습니다. 실제 AI 서비스 연동이 필요합니다."
                }
            ];
            
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            notification.innerHTML = `
                <strong>${randomMessage.title}</strong><br>
                ${randomMessage.content}
            `;
            
            document.body.appendChild(notification);
            
            // 4-7초 사이 랜덤하게 제거
            const removeTime = Math.random() * 3000 + 4000;
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, removeTime);
            
            // 클릭으로 제거
            notification.addEventListener('click', function() {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            });
        }

        // 네트워크 상태 모니터링
        window.addEventListener('online', function() {
            trackUserAction('network_online', {
                sessionId: sessionId
            });
        });

        window.addEventListener('offline', function() {
            trackUserAction('network_offline', {
                sessionId: sessionId
            });
            showErrorMessage('인터넷 연결이 끊어졌습니다. 연결을 확인해주세요.');
        });
    </script> </body>
</html>
